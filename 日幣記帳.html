<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…æ—¥åŠ©æ‰‹ - æ”¯å‡ºçµ±è¨ˆç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #f7f3f0;
            --container-bg: #ffffff;
            --coffee-dark: #5d4037;
            --coffee-medium: #8d6e63;
            --soft-beige: #efebe9;
            --primary-orange: #e67e22;
            --light-orange: #ffe0b2;
            --text-main: #3e2723;
        }

        body {
            font-family: -apple-system, "Noto Sans TC", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0; padding: 0;
            display: flex; flex-direction: column; align-items: center;
        }

        /* Tab Bar */
        .tab-bar {
            width: 100%; max-width: 480px;
            display: flex; background: var(--container-bg);
            margin-top: 10px; border-radius: 15px 15px 0 0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            position: sticky; top: 0; z-index: 100;
        }
        .tab-btn {
            flex: 1; padding: 15px; border: none; background: none;
            color: var(--coffee-medium); cursor: pointer;
            border-bottom: 3px solid transparent; font-size: 1rem;
        }
        .tab-btn.active {
            color: var(--primary-orange); border-bottom: 3px solid var(--primary-orange); font-weight: bold;
        }

        .container {
            width: 100%; max-width: 480px;
            background: var(--container-bg);
            border-radius: 0 0 20px 20px;
            box-shadow: 0 10px 25px rgba(93, 64, 55, 0.1);
            padding: 20px; box-sizing: border-box; min-height: 90vh;
        }

        .view-section { display: none; }
        .view-section.active { display: block; }

        /* Header Controls */
        .header-controls {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;
        }
        .header-controls h3 { margin: 0; font-size: 1.1rem; flex-grow: 1; text-align: center; }
        
        input[type="date"], select {
            padding: 6px 8px; border-radius: 8px; border: 1px solid #d7ccc8;
            font-family: inherit; font-size: 0.85rem; background: #fff; color: var(--coffee-dark);
        }

        /* Calculator Display */
        .calc-display {
            background: #fff; padding: 15px; border-radius: 15px;
            text-align: right; margin-bottom: 15px; border: 2px solid var(--soft-beige);
        }
        .calc-twd { font-size: 1rem; color: var(--coffee-medium); margin-bottom: 5px; }
        .calc-jpy { font-size: 2.8rem; font-weight: bold; color: var(--coffee-dark); line-height: 1; }
        .label { font-size: 0.7rem; color: #aaa; margin-right: 5px; }

        /* Keypad */
        .numpad {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px;
        }
        .numpad button {
            padding: 18px 5px; font-size: 1.3rem; border: none;
            background: var(--soft-beige); color: var(--coffee-dark); border-radius: 12px; cursor: pointer;
        }
        .numpad button:active { background: #d7ccc8; }

        /* Category */
        .category-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px;
        }
        .cat-btn {
            padding: 12px 5px; border: 1px solid var(--soft-beige);
            border-radius: 10px; background: #fff; color: var(--coffee-medium); font-size: 0.9rem; cursor: pointer;
        }
        .cat-btn.active {
            background: var(--light-orange); color: var(--primary-orange);
            border-color: var(--primary-orange); font-weight: bold;
        }

        .btn-confirm {
            width: 100%; padding: 18px; background: var(--primary-orange);
            color: white; border: none; border-radius: 12px;
            font-size: 1.2rem; font-weight: bold; box-shadow: 0 4px 0 #d35400; margin-bottom: 25px; cursor: pointer;
        }

        /* Record Item List */
        .record-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px solid #efebe9;
        }
        .record-jpy { font-size: 1.5rem; font-weight: bold; color: var(--coffee-dark); }
        .record-twd { font-size: 0.85rem; color: var(--coffee-medium); }

        /* Spending Stats View */
        .date-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
        .date-tag {
            padding: 6px 12px; border-radius: 20px; border: 1px solid var(--coffee-medium);
            cursor: pointer; font-size: 0.85rem; color: var(--coffee-medium);
        }
        .date-tag.selected {
            background: var(--primary-orange); color: white; border-color: var(--primary-orange);
        }

        .summary-box {
            background: var(--soft-beige); padding: 15px; border-radius: 15px;
            text-align: center; margin-bottom: 20px;
        }
    </style>
</head>
<body>

<div class="tab-bar">
    <button class="tab-btn active" onclick="showView('calc', this)">æ›ç®—è¨˜å¸³</button>
    <button class="tab-btn" onclick="showView('history', this)">æ”¯å‡ºçµ±è¨ˆ</button>
</div>

<div class="container">
    
    <!-- åˆ†é ä¸€ï¼šæ—¥å¹£æ›ç®—è¨˜å¸³ -->
    <div id="view-calc" class="view-section active">
        <div class="header-controls">
            <!-- å·¦å´æ—¥æ›†é¸å–® -->
            <input type="date" id="recordDate" onchange="syncDateChange()">
            <h3>æ—¥å¹£æ›ç®—è¨˜å¸³</h3>
            <!-- å³å´åŒ¯ç‡è¨­å®š -->
            <button onclick="toggleRate()" style="background:none; border:1px solid #d7ccc8; border-radius:12px; padding:4px 8px; color:#8d6e63; font-size:0.75rem; cursor:pointer;">åŒ¯ç‡è¨­å®š</button>
        </div>

        <div id="rateSection" style="display:none; margin-bottom:15px; background:var(--soft-beige); padding:10px; border-radius:10px; text-align:center;">
            <span style="font-size:0.8rem;">1 JPY = </span>
            <input type="number" id="exchangeRate" value="0.215" step="0.001" oninput="updateConverted()" style="width:70px; padding:4px;">
            <span style="font-size:0.8rem;"> TWD</span>
        </div>

        <div class="calc-display">
            <div class="calc-twd"><span class="label">TWD</span>$ <span id="twdDisplay">0</span></div>
            <div class="calc-jpy"><span class="label">JPY</span>Â¥ <span id="jpyDisplay">0</span></div>
        </div>

        <div class="numpad">
            <button onclick="pressNum('7')">7</button><button onclick="pressNum('8')">8</button><button onclick="pressNum('9')">9</button><button onclick="pressClear()" style="color:#d32f2f">C</button>
            <button onclick="pressNum('4')">4</button><button onclick="pressNum('5')">5</button><button onclick="pressNum('6')">6</button><button onclick="pressNum('000')">000</button>
            <button onclick="pressNum('1')">1</button><button onclick="pressNum('2')">2</button><button onclick="pressNum('3')">3</button><button onclick="pressNum('0')">0</button>
        </div>

        <div class="category-grid">
            <button class="cat-btn" onclick="setCategory('é£²é£Ÿ', this)">é£²é£Ÿ</button>
            <button class="cat-btn" onclick="setCategory('æœè£', this)">æœè£</button>
            <button class="cat-btn" onclick="setCategory('ç”¨å“', this)">ç”¨å“</button>
            <button class="cat-btn" onclick="setCategory('è—¥å¦', this)">è—¥å¦</button>
            <button class="cat-btn" onclick="setCategory('äº¤é€š', this)">äº¤é€š</button>
            <button class="cat-btn" onclick="showCustomInput(this)">ï¼‹è‡ªå®šç¾©</button>
        </div>
        <input type="text" id="customCatInput" placeholder="è¼¸å…¥è‡ªå®šç¾©é¡åˆ¥..." style="display:none; width:100%; padding:10px; margin-bottom:15px; border-radius:10px; border:1px solid #ddd; box-sizing:border-box;">

        <button class="btn-confirm" onclick="addRecord()">ç¢ºèªç´€éŒ„</button>

        <!-- å³æ™‚æ¸…å–® -->
        <div style="border-left:4px solid var(--primary-orange); padding-left:10px; margin-top:20px;">
            <h4 style="margin:0;">è©²æ—¥æ”¯å‡ºæ˜ç´°</h4>
        </div>
        <div id="calcDetailList" style="margin-top:10px;"></div>
    </div>

    <!-- åˆ†é äºŒï¼šæ”¯å‡ºçµ±è¨ˆ -->
    <div id="view-history" class="view-section">
        <h3 style="margin-top:0;">ğŸ“… æ”¯å‡ºçµ±è¨ˆ</h3>
        <p style="font-size:0.8rem; color:#888;">é¸å–æ—¥æœŸé€²è¡Œå¤šæ—¥åŠ ç¸½å°æ¯”ï¼š</p>
        
        <div class="date-tags" id="historyDateTags"></div>

        <div class="summary-box">
            <div style="font-size: 0.9rem; color: #888;">æ‰€é¸æ—¥æœŸç¸½è¨ˆ</div>
            <div style="font-size: 2rem; font-weight: bold; color: var(--primary-orange);">$ <span id="historyTotalTWD">0</span></div>
            <div style="font-size: 0.9rem; color: #aaa;">ç´„ Â¥ <span id="historyTotalJPY">0</span></div>
        </div>

        <div style="max-width:280px; margin: 0 auto 30px;">
            <canvas id="historyChart"></canvas>
        </div>

        <div id="historyDetailList"></div>
    </div>

</div>

<script>
    let currentJPY = "0";
    let selectedCategory = "";
    let isCustom = false;
    let records = JSON.parse(localStorage.getItem('jpy_trip_v5')) || [];
    let historySelectedDates = []; 
    let historyChart = null;

    // åˆå§‹æ—¥æœŸè¨­å®š
    const todayStr = new Date().toLocaleDateString('en-CA');
    document.getElementById('recordDate').value = todayStr;

    window.onload = () => {
        renderCalcList();
    };

    function showView(view, btn) {
        document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('view-' + view).classList.add('active');
        btn.classList.add('active');
        if(view === 'history') renderHistoryTab();
    }

    // è¨ˆç®—æ©ŸåŠŸèƒ½
    function toggleRate() {
        const s = document.getElementById('rateSection');
        s.style.display = (s.style.display === 'none') ? 'block' : 'none';
    }

    function pressNum(num) {
        if (currentJPY === "0") currentJPY = (num === "000" || num === "0") ? "0" : num;
        else currentJPY += num;
        updateConverted();
    }

    function pressClear() { currentJPY = "0"; updateConverted(); }

    function updateConverted() {
        const rate = parseFloat(document.getElementById('exchangeRate').value) || 0;
        const jpy = parseFloat(currentJPY);
        document.getElementById('jpyDisplay').innerText = jpy.toLocaleString();
        document.getElementById('twdDisplay').innerText = Math.round(jpy * rate).toLocaleString();
    }

    function setCategory(cat, btn) {
        isCustom = false;
        selectedCategory = cat;
        document.getElementById('customCatInput').style.display = 'none';
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    function showCustomInput(btn) {
        isCustom = true;
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('customCatInput').style.display = 'block';
    }

    function syncDateChange() {
        renderCalcList();
    }

    // æ–°å¢ç´€éŒ„
    function addRecord() {
        const jpy = parseFloat(currentJPY);
        if (jpy <= 0) return;
        const cat = isCustom ? document.getElementById('customCatInput').value.trim() : selectedCategory;
        if (!cat) { alert("è«‹é¸æ“‡é¡åˆ¥"); return; }

        const rate = parseFloat(document.getElementById('exchangeRate').value) || 0;
        const targetDate = document.getElementById('recordDate').value;

        records.push({
            id: Date.now(),
            date: targetDate,
            category: cat,
            jpy: jpy,
            twd: Math.round(jpy * rate)
        });
        save();
        renderCalcList();
        pressClear();
    }

    function renderCalcList() {
        const targetDate = document.getElementById('recordDate').value;
        const list = document.getElementById('calcDetailList');
        const filtered = records.filter(r => r.date === targetDate);
        
        if(filtered.length === 0) {
            list.innerHTML = "<p style='text-align:center; color:#aaa; font-size:0.8rem; margin-top:20px;'>æ­¤æ—¥æœŸå°šç„¡ç´€éŒ„</p>";
            return;
        }

        list.innerHTML = filtered.sort((a,b)=>b.id-a.id).map(r => `
            <div class="record-item">
                <div style="font-size:0.9rem;"><b>${r.category}</b></div>
                <div style="text-align:right">
                    <div class="record-jpy">Â¥${r.jpy.toLocaleString()}</div>
                    <div class="record-twd">$${r.twd.toLocaleString()}</div>
                </div>
            </div>
        `).join('');
    }

    // --- æ”¯å‡ºçµ±è¨ˆåˆ†é é‚è¼¯ ---
    function renderHistoryTab() {
        const tagContainer = document.getElementById('historyDateTags');
        const uniqueDates = [...new Set(records.map(r => r.date))].sort().reverse();

        tagContainer.innerHTML = uniqueDates.map(d => `
            <div class="date-tag ${historySelectedDates.includes(d) ? 'selected' : ''}" onclick="toggleHistoryDate('${d}')">
                ${d}
            </div>
        `).join('');

        updateHistoryStats();
    }

    function toggleHistoryDate(date) {
        if(historySelectedDates.includes(date)) {
            historySelectedDates = historySelectedDates.filter(d => d !== date);
        } else {
            historySelectedDates.push(date);
        }
        renderHistoryTab();
    }

    function updateHistoryStats() {
        const filtered = records.filter(r => historySelectedDates.includes(r.date));
        const list = document.getElementById('historyDetailList');
        let totalTWD = 0, totalJPY = 0;
        let catStats = {};

        filtered.forEach(r => {
            totalTWD += r.twd;
            totalJPY += r.jpy;
            catStats[r.category] = (catStats[r.category] || 0) + r.twd;
        });

        document.getElementById('historyTotalTWD').innerText = totalTWD.toLocaleString();
        document.getElementById('historyTotalJPY').innerText = totalJPY.toLocaleString();

        const ctx = document.getElementById('historyChart').getContext('2d');
        if(historyChart) historyChart.destroy();
        
        if(Object.keys(catStats).length > 0) {
            historyChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(catStats),
                    datasets: [{
                        data: Object.values(catStats),
                        backgroundColor: ['#e67e22', '#8d6e63', '#d7ccc8', '#ffe0b2', '#5d4037', '#a1887f'],
                        borderWidth: 2
                    }]
                },
                options: { plugins: { legend: { position: 'bottom' } } }
            });
        }

        list.innerHTML = filtered.sort((a,b)=>b.id-a.id).map(r => `
            <div class="record-item">
                <div style="font-size:0.85rem;"><b>${r.category}</b><br><span style="color:#aaa; font-size:0.75rem;">${r.date}</span></div>
                <div style="text-align:right">
                    <div class="record-jpy">Â¥${r.jpy.toLocaleString()}</div>
                    <div class="record-twd">$${r.twd.toLocaleString()}</div>
                </div>
            </div>
        `).join('');
    }

    function save() { localStorage.setItem('jpy_trip_v5', JSON.stringify(records)); }

</script>

</body>
</html>